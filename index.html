<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vesting Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.1/ethers.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/4.2.2/web3.min.js"></script>
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px 0;
            border-bottom: 1px solid #333;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00ff88, #00cc6a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #888;
            font-size: 1.1em;
        }

        .chain-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .chain-btn {
            background: linear-gradient(145deg, #1a1a1a, #2a2a2a);
            border: 2px solid #333;
            color: #e0e0e0;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
            font-weight: 600;
        }

        .chain-btn:hover {
            border-color: #00ff88;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .chain-btn.active {
            background: linear-gradient(145deg, #00ff88, #00cc6a);
            color: #000;
            border-color: #00ff88;
        }

        .contract-info {
            background: linear-gradient(145deg, #1a1a1a, #2a2a2a);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid #333;
            text-align: center;
        }

        .contract-address {
            font-family: monospace;
            font-size: 0.9em;
            color: #00ff88;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 12px;
            border-radius: 6px;
            display: inline-block;
            margin-top: 5px;
        }

        .refresh-btn {
            background: linear-gradient(145deg, #00ff88, #00cc6a);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 20px 0;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.4);
        }

        .refresh-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .vesting-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-card {
            background: linear-gradient(145deg, #1a1a1a, #2a2a2a);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #333;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .info-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.2);
        }

        .info-card h3 {
            color: #00ff88;
            margin-bottom: 16px;
            font-size: 1.2em;
            border-bottom: 2px solid #333;
            padding-bottom: 8px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .info-label {
            color: #999;
            font-weight: 500;
        }

        .info-value {
            color: #e0e0e0;
            font-weight: 600;
            text-align: right;
        }

        .recipients-section {
            background: linear-gradient(145deg, #1a1a1a, #2a2a2a);
            border-radius: 16px;
            padding: 30px;
            border: 1px solid #333;
            margin-bottom: 20px;
        }

        .recipients-title {
            color: #00ff88;
            font-size: 1.4em;
            margin-bottom: 20px;
            border-bottom: 2px solid #333;
            padding-bottom: 10px;
        }

        .recipient-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #444;
            transition: all 0.3s ease;
        }

        .recipient-card:hover {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }

        .recipient-address {
            font-family: monospace;
            font-size: 0.9em;
            color: #00ff88;
            margin-bottom: 10px;
            word-break: break-all;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00cc6a);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .error-message {
            background: linear-gradient(145deg, #ff4444, #cc3333);
            color: white;
            padding: 16px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #333;
            border-left: 4px solid #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active {
            background: #00ff88;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .status-inactive {
            background: #666;
        }

        .last-updated {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-top: 20px;
        }

        .debug-section {
            background: linear-gradient(145deg, #1a1a1a, #2a2a2a);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }

        .debug-title {
            color: #ff8800;
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .debug-data {
            font-family: monospace;
            font-size: 0.8em;
            color: #ccc;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 6px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .chain-selector {
                flex-direction: column;
                align-items: center;
            }
            
            .vesting-info {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }

            .contract-address {
                font-size: 0.8em;
                word-break: break-all;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Vesting Dashboard</h1>
            <p>Monitor token vesting schedules across multiple chains</p>
        </div>

        <div class="chain-selector">
            <button class="chain-btn active" data-chain="bnb">BNB Smart Chain</button>
            <button class="chain-btn" data-chain="solana">Solana</button>
        </div>

        <div class="contract-info">
            <div>Contract/Program Address:</div>
            <div class="contract-address" id="currentContract">-</div>
            <button class="refresh-btn" onclick="refreshVestingInfo()">Refresh Data</button>
        </div>

        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
        </div>

        <div id="errorMessage" class="error-message hidden"></div>

        <!-- Debug section for Solana -->
        <div id="debugSection" class="debug-section hidden">
            <div class="debug-title">Debug Information (Raw Account Data)</div>
            <div class="debug-data" id="debugData"></div>
        </div>

        <div id="vestingData" class="hidden">
            <div class="vesting-info">
                <div class="info-card">
                    <h3>Schedule Details</h3>
                    <div class="info-item">
                        <span class="info-label">Status</span>
                        <span class="info-value" id="status">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Start Time</span>
                        <span class="info-value" id="startTime">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Cliff Duration</span>
                        <span class="info-value" id="cliffDuration">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Vesting Duration</span>
                        <span class="info-value" id="vestingDuration">-</span>
                    </div>
                </div>

                <div class="info-card">
                    <h3>Token Information</h3>
                    <div class="info-item">
                        <span class="info-label">Total Amount</span>
                        <span class="info-value" id="totalAmount">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Claimed Amount</span>
                        <span class="info-value" id="claimedAmount">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Available to Claim</span>
                        <span class="info-value" id="claimableAmount">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Remaining</span>
                        <span class="info-value" id="remainingAmount">-</span>
                    </div>
                </div>

                <div class="info-card">
                    <h3>Progress</h3>
                    <div class="info-item">
                        <span class="info-label">Current Period</span>
                        <span class="info-value" id="currentPeriod">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Unlocked Percentage</span>
                        <span class="info-value" id="unlockedPercentage">-</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Next Claim Available</span>
                        <span class="info-value" id="nextClaim">-</span>
                    </div>
                </div>
            </div>

            <div class="recipients-section">
                <h3 class="recipients-title">Recipients (<span id="recipientCount">0</span>)</h3>
                <div id="recipientsList"></div>
            </div>

            <div class="last-updated" id="lastUpdated"></div>
        </div>
    </div>

    <script>
        let currentChain = 'bnb';
        let web3 = null;
        let connection = null;
        let refreshInterval = null;

        // Configuration - ADD YOUR ADDRESSES HERE
        const CONFIG = {
            bnb: {
                rpcUrl: 'https://bsc-testnet.drpc.org',
                contractAddress: '0xEAA6c8F73116f5D08bfb90a93Ee7aAcbd1498E84', // REPLACE WITH ACTUAL CONTRACT ADDRESS
                beneficiaryAddress: '0xea755aBa09CaAc2F73C4b6288256FF4Ae88beFbC', // REPLACE WITH ACTUAL BENEFICIARY ADDRESS
                name: 'BNB Smart Chain',
                fallbackRPCs: [
                    'https://bsc-testnet.drpc.org',
                    'https://bsc-dataseed3.binance.org/',
                    'https://bsc-dataseed4.binance.org/'
                ]
            },
            solana: {
                rpcUrl: 'https://api.devnet.solana.com',
                // ОБНОВИТЕ ЭТИ АДРЕСА НА ВАШИ РЕАЛЬНЫЕ
                
                vestingPDA: 'GFZRzf3S5siZ9ooYyLKD16qUPWNWvaMMv6qhWyZRnPKa', // PDA вашего vesting аккаунта
                programId: 'HVj5FnTMfVSrDhiJyZAKFo1BmcBN2L7MRjvHvdxz9HKj', // ID вашей программы
                name: 'Solana'
            }
        };

        // BNB Contract ABI (остается как есть)
        const contractABI = [
            {
                "inputs": [{"name": "_beneficiary", "type": "address"}],
                "name": "getVestingSchedule",
                "outputs": [
                    {"name": "isInitialized", "type": "bool"},
                    {"name": "token", "type": "address"},
                    {"name": "startTime", "type": "uint256"},
                    {"name": "cliffDuration", "type": "uint256"},
                    {"name": "vestingDuration", "type": "uint256"},
                    {"name": "totalAmount", "type": "uint256"},
                    {"name": "claimedAmount", "type": "uint256"},
                    {"name": "lastClaimTime", "type": "uint256"},
                    {"name": "currentPeriod", "type": "uint8"},
                    {"name": "recipientCount", "type": "uint8"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"name": "_beneficiary", "type": "address"}],
                "name": "getVestingProgress",
                "outputs": [
                    {"name": "elapsedTime", "type": "uint256"},
                    {"name": "currentPeriod", "type": "uint8"},
                    {"name": "unlockedPercentage", "type": "uint256"},
                    {"name": "unlockedAmount", "type": "uint256"},
                    {"name": "claimableAmount", "type": "uint256"},
                    {"name": "remainingAmount", "type": "uint256"},
                    {"name": "canClaimNow", "type": "bool"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"name": "_beneficiary", "type": "address"}],
                "name": "getRecipients",
                "outputs": [
                    {
                        "components": [
                            {"name": "wallet", "type": "address"},
                            {"name": "percentage", "type": "uint8"}
                        ],
                        "name": "",
                        "type": "tuple[]"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"name": "_beneficiary", "type": "address"}],
                "name": "canClaim",
                "outputs": [{"name": "", "type": "bool"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeChain();
            loadVestingInfo();
            
            // Set up auto-refresh every 30 seconds
            refreshInterval = setInterval(loadVestingInfo, 30000);
            
            // Chain selector
            document.querySelectorAll('.chain-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.chain-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentChain = this.dataset.chain;
                    initializeChain();
                    clearData();
                    loadVestingInfo();
                });
            });
        });

        function initializeChain() {
            const config = CONFIG[currentChain];
            
            if (currentChain === 'bnb') {
                web3 = new Web3(config.rpcUrl);
                document.getElementById('currentContract').textContent = config.contractAddress;
                document.getElementById('debugSection').classList.add('hidden');
            } else {
                // Проверяем доступность Solana Web3
                if (typeof solanaWeb3 !== 'undefined' && solanaWeb3.Connection) {
                    connection = new solanaWeb3.Connection(config.rpcUrl);
                } else if (typeof window.solanaWeb3 !== 'undefined' && window.solanaWeb3.Connection) {
                    connection = new window.solanaWeb3.Connection(config.rpcUrl);
                } else {
                    console.error('Solana Web3.js not loaded properly');
                    showError('Solana Web3.js library not loaded. Please refresh the page.');
                    return;
                }
                
                document.getElementById('currentContract').textContent = config.vestingPDA;
                document.getElementById('debugSection').classList.remove('hidden');
            }
        }

        function clearData() {
            document.getElementById('vestingData').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('debugData').textContent = '';
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').classList.remove('hidden');
            document.getElementById('vestingData').classList.add('hidden');
        }

        function showLoading(show) {
            if (show) {
                document.getElementById('loading').classList.remove('hidden');
            } else {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function refreshVestingInfo() {
            loadVestingInfo();
        }

        async function loadVestingInfo() {
            showLoading(true);
            clearData();

            try {
                if (currentChain === 'bnb') {
                    await fetchBNBVestingInfo();
                } else {
                    await fetchSolanaVestingInfo();
                }
                
                // Update last updated time
                document.getElementById('lastUpdated').textContent = 
                    `Last updated: ${new Date().toLocaleString()}`;
                    
            } catch (error) {
                console.error('Error fetching vesting info:', error);
                showError('Failed to fetch vesting information: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function fetchBNBVestingInfo() {
            const config = CONFIG.bnb;
            
            // Все проверки остаются как в оригинале
            if (!config.contractAddress || config.contractAddress === '') {
                showError('Please configure the contract address in CONFIG.bnb.contractAddress');
                return;
            }
            
            if (!config.beneficiaryAddress || config.beneficiaryAddress === '') {
                showError('Please configure the beneficiary address in CONFIG.bnb.beneficiaryAddress');
                return;
            }
            
            if (!web3.utils.isAddress(config.contractAddress)) {
                showError('Invalid contract address format');
                return;
            }
            
            if (!web3.utils.isAddress(config.beneficiaryAddress)) {
                showError('Invalid beneficiary address format');
                return;
            }
            
            try {
                const contract = new web3.eth.Contract(contractABI, config.contractAddress);
                
                console.log('Checking contract at:', config.contractAddress);
                console.log('For beneficiary:', config.beneficiaryAddress);
                
                const code = await web3.eth.getCode(config.contractAddress);
                if (code === '0x') {
                    showError('No contract found at the specified address. Please verify the contract address.');
                    return;
                }
                
                try {
                    const schedule = await contract.methods.getVestingSchedule(config.beneficiaryAddress).call();
                    console.log('Vesting schedule result:', schedule);
                    
                    if (!schedule || (!schedule.isInitialized && schedule[0] !== true)) {
                        showError('No vesting schedule found for this beneficiary address');
                        return;
                    }

                    const [progress, recipients, canClaim] = await Promise.all([
                        contract.methods.getVestingProgress(config.beneficiaryAddress).call(),
                        contract.methods.getRecipients(config.beneficiaryAddress).call(),
                        contract.methods.canClaim(config.beneficiaryAddress).call()
                    ]);
                    
                    console.log('Progress:', progress);
                    console.log('Recipients:', recipients);
                    console.log('Can claim:', canClaim);

                    displayBNBVestingInfo(schedule, progress, recipients, canClaim);
                    
                } catch (callError) {
                    console.error('Contract call error:', callError);
                    
                    if (callError.message.includes('revert')) {
                        showError('Contract reverted - possibly no vesting data for this beneficiary');
                    } else if (callError.message.includes('invalid address')) {
                        showError('Invalid address provided to contract');
                    } else if (callError.message.includes('execution reverted')) {
                        showError('Contract execution failed - check if addresses are correct');
                    } else {
                        showError('Contract call failed: ' + callError.message);
                    }
                }
                
            } catch (error) {
                console.error('Network error:', error);
                showError('Network error: ' + error.message);
            }
        }

        async function fetchSolanaVestingInfo() {
            const config = CONFIG.solana;
            
            try {
                console.log('Fetching Solana vesting info from:', config.vestingPDA);
                
                // Проверяем доступность Solana Web3
                if (typeof solanaWeb3 === 'undefined') {
                    showError('Solana Web3.js library not loaded properly. Please refresh the page.');
                    return;
                }
                
                // Проверяем, что адрес корректный
                let publicKey;
                try {
                    // Пробуем разные способы создания PublicKey
                    if (solanaWeb3.PublicKey) {
                        publicKey = new solanaWeb3.PublicKey(config.vestingPDA);
                    } else if (window.solanaWeb3?.PublicKey) {
                        publicKey = new window.solanaWeb3.PublicKey(config.vestingPDA);
                    } else {
                        // Fallback: проверяем формат вручную
                        if (!/^[1-9A-HJ-NP-Za-km-z]{32,44}$/.test(config.vestingPDA)) {
                            throw new Error('Invalid address format');
                        }
                        showError('Solana Web3.js PublicKey constructor not available');
                        return;
                    }
                } catch (e) {
                    console.error('PublicKey creation error:', e);
                    showError('Invalid Solana address format: ' + config.vestingPDA + ' - ' + e.message);
                    return;
                }
                
                console.log('Created PublicKey:', publicKey.toString());
                
                // Получаем данные аккаунта
                const accountInfo = await connection.getAccountInfo(publicKey);
                
                if (!accountInfo) {
                    showError('No account found at address: ' + config.vestingPDA + '. Make sure the vesting account is initialized.');
                    return;
                }
                
                console.log('Account info received:', {
                    lamports: accountInfo.lamports,
                    owner: accountInfo.owner.toString(),
                    dataLength: accountInfo.data.length,
                    executable: accountInfo.executable
                });

                // Показываем raw данные для дебага
                const debugData = {
                    address: config.vestingPDA,
                    owner: accountInfo.owner.toString(),
                    lamports: accountInfo.lamports,
                    dataLength: accountInfo.data.length,
                    executable: accountInfo.executable,
                    rentEpoch: accountInfo.rentEpoch,
                    firstBytes: Array.from(accountInfo.data.slice(0, 50)).map(b => '0x' + b.toString(16).padStart(2, '0')).join(' ')
                };
                
                document.getElementById('debugData').textContent = JSON.stringify(debugData, null, 2);
                
                // Проверяем, принадлежит ли аккаунт нашей программе
                let expectedOwner;
                try {
                    expectedOwner = new solanaWeb3.PublicKey(config.programId);
                } catch (e) {
                    console.warn('Could not verify program ownership:', e);
                    // Продолжаем без проверки владельца
                }
                
                if (expectedOwner && !accountInfo.owner.equals(expectedOwner)) {
                    showError(`Account owner mismatch. Expected: ${expectedOwner.toString()}, Got: ${accountInfo.owner.toString()}`);
                    return;
                }
                
                // Парсим данные аккаунта
                const vestingData = parseVestingAccount(accountInfo.data);
                
                if (!vestingData) {
                    showError('Failed to parse vesting account data');
                    return;
                }
                
                console.log('Parsed vesting data:', vestingData);
                displaySolanaVestingInfo(vestingData);
                
            } catch (error) {
                console.error('Error fetching Solana data:', error);
                showError('Solana fetch error: ' + error.message);
            }
        }

        function parseVestingAccount(data) {
            try {
                // Проверяем минимальную длину
                if (data.length < 200) {
                    console.error('Account data too short:', data.length);
                    return null;
                }
                
                console.log('Parsing account data, length:', data.length);
                
                // Парсим согласно структуре из state.rs
                let offset = 0;
                
                // is_initialized (1 byte)
                const isInitialized = data[offset] !== 0;
                offset += 1;
                
                    // initializer (32 bytes)
                    let initializer;
                    try {
                        initializer = createPublicKeyFromBytes(data.slice(offset, offset + 32));
                    } catch (e) {
                        console.error('Failed to create initializer PublicKey:', e);
                        initializer = 'Invalid';
                    }
                    offset += 32;
                    
                    // mint (32 bytes)  
                    let mint;
                    try {
                        mint = createPublicKeyFromBytes(data.slice(offset, offset + 32));
                    } catch (e) {
                        console.error('Failed to create mint PublicKey:', e);
                        mint = 'Invalid';
                    }
                    offset += 32;
                    
                    // vault (32 bytes)
                    let vault;
                    try {
                        vault = createPublicKeyFromBytes(data.slice(offset, offset + 32));
                    } catch (e) {
                        console.error('Failed to create vault PublicKey:', e);
                        vault = 'Invalid';
                    }
                    offset += 32;
                
                // start_time (8 bytes, i64)
                const startTime = readInt64LE(data, offset);
                offset += 8;
                
                // total_amount (8 bytes, u64)
                const totalAmount = readUint64LE(data, offset);
                offset += 8;
                
                // schedule.cliff_period (8 bytes, i64)
                const cliffPeriod = readInt64LE(data, offset);
                offset += 8;
                
                // schedule.vesting_period (8 bytes, i64)
                const vestingPeriod = readInt64LE(data, offset);
                offset += 8;
                
                // schedule.tge_percentage (1 byte)
                const tgePercentage = data[offset];
                offset += 1;
                
                // recipient_count (1 byte)
                const recipientCount = data[offset];
                offset += 1;
                
                // is_revoked (1 byte)
                const isRevoked = data[offset] !== 0;
                offset += 1;
                
                console.log('Parsed basic data:', {
                    isInitialized,
                    initializer: typeof initializer === 'string' ? initializer : initializer.toString(),
                    mint: typeof mint === 'string' ? mint : mint.toString(),
                    vault: typeof vault === 'string' ? vault : vault.toString(),
                    startTime: startTime.toString(),
                    totalAmount: totalAmount.toString(),
                    cliffPeriod: cliffPeriod.toString(),
                    vestingPeriod: vestingPeriod.toString(),
                    tgePercentage,
                    recipientCount,
                    isRevoked
                });
                
                // Parse recipients (максимум 10)
                const recipients = [];
                for (let i = 0; i < 10; i++) {
                    // wallet (32 bytes)
                    let wallet;
                    try {
                        wallet = createPublicKeyFromBytes(data.slice(offset, offset + 32));
                    } catch (e) {
                        wallet = 'Invalid';
                    }
                    offset += 32;
                    
                    // percentage (1 byte)
                    const percentage = data[offset];
                    offset += 1;
                    
                    // claimed_amount (8 bytes, u64)
                    const claimedAmount = readUint64LE(data, offset);
                    offset += 8;
                    
                    // last_claim_time (8 bytes, i64)
                    const lastClaimTime = readInt64LE(data, offset);
                    offset += 8;
                    
                    // Добавляем только не пустых получателей
                    const isValidWallet = wallet !== 'Invalid' && (typeof wallet === 'string' || !wallet.equals(getDefaultPublicKey()));
                    if (isValidWallet && percentage > 0) {
                        recipients.push({
                            wallet: typeof wallet === 'string' ? wallet : wallet.toString(),
                            percentage,
                            claimedAmount: claimedAmount.toString(),
                            lastClaimTime: lastClaimTime.toString()
                        });
                    }
                }
                
                console.log('Parsed recipients:', recipients);
                
                return {
                    isInitialized,
                    initializer: typeof initializer === 'string' ? initializer : initializer.toString(),
                    mint: typeof mint === 'string' ? mint : mint.toString(),
                    vault: typeof vault === 'string' ? vault : vault.toString(),
                    startTime: Number(startTime),
                    totalAmount: totalAmount.toString(),
                    schedule: {
                        cliffPeriod: Number(cliffPeriod),
                        vestingPeriod: Number(vestingPeriod),
                        tgePercentage
                    },
                    recipients,
                    recipientCount,
                    isRevoked
                };
                
            } catch (error) {
                console.error('Error parsing vesting account:', error);
                return null;
            }
        }

        // Helper functions для работы с Solana PublicKey
        function createPublicKeyFromBytes(bytes) {
            if (solanaWeb3 && solanaWeb3.PublicKey) {
                return new solanaWeb3.PublicKey(bytes);
            } else if (window.solanaWeb3 && window.solanaWeb3.PublicKey) {
                return new window.solanaWeb3.PublicKey(bytes);
            } else {
                // Fallback: создаем base58 строку вручную
                return bytesToBase58(bytes);
            }
        }

        function getDefaultPublicKey() {
            try {
                if (solanaWeb3 && solanaWeb3.PublicKey) {
                    return solanaWeb3.PublicKey.default;
                } else if (window.solanaWeb3 && window.solanaWeb3.PublicKey) {
                    return window.solanaWeb3.PublicKey.default;
                }
            } catch (e) {
                // Fallback
            }
            return null;
        }

        function bytesToBase58(bytes) {
            // Простая реализация для отображения адреса
            const alphabet = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
            let result = '';
            
            // Это упрощенная версия, для полной реализации нужна библиотека
            for (let i = 0; i < Math.min(bytes.length, 8); i++) {
                result += bytes[i].toString(16).padStart(2, '0');
            }
            result += '...';
            
            return result;
        }

        // Helper functions для чтения little-endian integers
        function readUint64LE(buffer, offset) {
            const low = buffer[offset] | (buffer[offset + 1] << 8) | (buffer[offset + 2] << 16) | (buffer[offset + 3] << 24);
            const high = buffer[offset + 4] | (buffer[offset + 5] << 8) | (buffer[offset + 6] << 16) | (buffer[offset + 7] << 24);
            return BigInt(low) + (BigInt(high) << 32n);
        }

        function readInt64LE(buffer, offset) {
            const value = readUint64LE(buffer, offset);
            // Проверяем знак (MSB)
            if (value >= 0x8000000000000000n) {
                return value - 0x10000000000000000n;
            }
            return value;
        }

        function displayBNBVestingInfo(schedule, progress, recipients, canClaim) {
            console.log('Displaying vesting info:', {schedule, progress, recipients, canClaim});
            
            // Handle different return formats (array vs object)
            const scheduleData = Array.isArray(schedule) ? {
                isInitialized: schedule[0],
                token: schedule[1],
                startTime: schedule[2],
                cliffDuration: schedule[3],
                vestingDuration: schedule[4],
                totalAmount: schedule[5],
                claimedAmount: schedule[6],
                lastClaimTime: schedule[7],
                currentPeriod: schedule[8],
                recipientCount: schedule[9]
            } : schedule;
            
            const progressData = Array.isArray(progress) ? {
                elapsedTime: progress[0],
                currentPeriod: progress[1],
                unlockedPercentage: progress[2],
                unlockedAmount: progress[3],
                claimableAmount: progress[4],
                remainingAmount: progress[5],
                canClaimNow: progress[6]
            } : progress;
            
            // Update basic info
            const statusElement = document.getElementById('status');
            const isActive = Number(scheduleData.startTime) > 0;
            statusElement.innerHTML = `
                <span class="status-indicator ${isActive ? 'status-active' : 'status-inactive'}"></span>
                ${isActive ? 'Active' : 'Not Started'}
            `;
            
            document.getElementById('startTime').textContent = Number(scheduleData.startTime) > 0 
                ? new Date(Number(scheduleData.startTime) * 1000).toLocaleString() 
                : 'Not started';
            document.getElementById('cliffDuration').textContent = formatDuration(scheduleData.cliffDuration);
            document.getElementById('vestingDuration').textContent = formatDuration(scheduleData.vestingDuration);
            
            // Update amounts
            document.getElementById('totalAmount').textContent = formatTokenAmount(scheduleData.totalAmount);
            document.getElementById('claimedAmount').textContent = formatTokenAmount(scheduleData.claimedAmount);
            document.getElementById('claimableAmount').textContent = formatTokenAmount(progressData.claimableAmount);
            document.getElementById('remainingAmount').textContent = formatTokenAmount(progressData.remainingAmount);
            
            // Update progress
            document.getElementById('currentPeriod').textContent = `${progressData.currentPeriod}/4`;
            document.getElementById('unlockedPercentage').textContent = `${progressData.unlockedPercentage}%`;
            document.getElementById('progressFill').style.width = `${Math.min(Number(progressData.unlockedPercentage), 100)}%`;
            
            // Update claim status
            if (canClaim) {
                document.getElementById('nextClaim').innerHTML = 
                    '<span style="color: #00ff88;">✓ Available now</span>';
            } else {
                document.getElementById('nextClaim').textContent = 'Not available';
            }

            // Display recipients
            displayRecipients(recipients, scheduleData.totalAmount);
            document.getElementById('recipientCount').textContent = Array.isArray(recipients) ? recipients.length : 0;

            document.getElementById('vestingData').classList.remove('hidden');
        }

        function displaySolanaVestingInfo(vestingData) {
            console.log('Displaying Solana vesting info:', vestingData);
            
            if (!vestingData.isInitialized) {
                showError('Vesting account is not initialized');
                return;
            }
            
            // Calculate current vesting progress
            const currentTime = Math.floor(Date.now() / 1000);
            const startTime = vestingData.startTime;
            const totalAmount = BigInt(vestingData.totalAmount);
            
            let elapsedTime = 0;
            let unlockedPercentage = 0;
            let currentPeriod = 0;
            
            if (startTime > 0 && currentTime >= startTime) {
                elapsedTime = currentTime - startTime;
                
                // Используем ту же логику вестинга что и в контракте
                if (elapsedTime >= 0 && elapsedTime < 300) {
                    unlockedPercentage = 10;
                    currentPeriod = 1;
                } else if (elapsedTime >= 300 && elapsedTime < 600) {
                    unlockedPercentage = 20;
                    currentPeriod = 2;
                } else if (elapsedTime >= 600 && elapsedTime < 900) {
                    unlockedPercentage = 50;
                    currentPeriod = 3;
                } else if (elapsedTime >= 900) {
                    unlockedPercentage = 100;
                    currentPeriod = 4;
                }
            }
            
            // Calculate total claimed amount across all recipients
            let totalClaimed = 0n;
            vestingData.recipients.forEach(recipient => {
                totalClaimed += BigInt(recipient.claimedAmount);
            });
            
            const unlockedAmount = totalAmount * BigInt(unlockedPercentage) / 100n;
            const claimableAmount = unlockedAmount - totalClaimed;
            const remainingAmount = totalAmount - unlockedAmount;
            
            // Update status
            const statusElement = document.getElementById('status');
            const isActive = startTime > 0;
            statusElement.innerHTML = `
                <span class="status-indicator ${isActive ? 'status-active' : 'status-inactive'}"></span>
                ${vestingData.isRevoked ? 'Revoked' : (isActive ? 'Active' : 'Not Started')}
            `;
            
            // Update schedule details
            document.getElementById('startTime').textContent = startTime > 0 
                ? new Date(startTime * 1000).toLocaleString() 
                : 'Not started';
            document.getElementById('cliffDuration').textContent = formatDuration(vestingData.schedule.cliffPeriod);
            document.getElementById('vestingDuration').textContent = formatDuration(vestingData.schedule.vestingPeriod);
            
            // Update amounts
            document.getElementById('totalAmount').textContent = formatSolanaTokenAmount(vestingData.totalAmount);
            document.getElementById('claimedAmount').textContent = formatSolanaTokenAmount(totalClaimed.toString());
            document.getElementById('claimableAmount').textContent = formatSolanaTokenAmount(claimableAmount.toString());
            document.getElementById('remainingAmount').textContent = formatSolanaTokenAmount(remainingAmount.toString());
            
            // Update progress
            document.getElementById('currentPeriod').textContent = `${currentPeriod}/4`;
            document.getElementById('unlockedPercentage').textContent = `${unlockedPercentage}%`;
            document.getElementById('progressFill').style.width = `${Math.min(unlockedPercentage, 100)}%`;
            
            // Update claim status
            const canClaim = claimableAmount > 0n && !vestingData.isRevoked;
            if (canClaim) {
                document.getElementById('nextClaim').innerHTML = 
                    '<span style="color: #00ff88;">✓ Available now</span>';
            } else if (vestingData.isRevoked) {
                document.getElementById('nextClaim').textContent = 'Revoked';
            } else {
                document.getElementById('nextClaim').textContent = 'Not available';
            }

            // Display recipients
            displaySolanaRecipients(vestingData.recipients, vestingData.totalAmount);
            document.getElementById('recipientCount').textContent = vestingData.recipients.length;

            document.getElementById('vestingData').classList.remove('hidden');
        }

        function displayRecipients(recipients, totalAmount) {
            const container = document.getElementById('recipientsList');
            container.innerHTML = '';

            if (!recipients || recipients.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666;">No recipients found</div>';
                return;
            }

            recipients.forEach((recipient, index) => {
                if (recipient.wallet === '0x0000000000000000000000000000000000000000') return;

                const recipientDiv = document.createElement('div');
                recipientDiv.className = 'recipient-card';
                
                const allocation = (BigInt(totalAmount) * BigInt(recipient.percentage) / BigInt(100));
                
                recipientDiv.innerHTML = `
                    <div class="recipient-address">${recipient.wallet}</div>
                    <div class="info-item">
                        <span class="info-label">Allocation</span>
                        <span class="info-value">${recipient.percentage}%</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Amount</span>
                        <span class="info-value">${formatTokenAmount(allocation.toString())}</span>
                    </div>
                `;
                
                container.appendChild(recipientDiv);
            });
        }

        function displaySolanaRecipients(recipients, totalAmount) {
            const container = document.getElementById('recipientsList');
            container.innerHTML = '';

            if (!recipients || recipients.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666;">No recipients found</div>';
                return;
            }

            recipients.forEach((recipient, index) => {
                const recipientDiv = document.createElement('div');
                recipientDiv.className = 'recipient-card';
                
                const allocation = (BigInt(totalAmount) * BigInt(recipient.percentage) / BigInt(100));
                
                recipientDiv.innerHTML = `
                    <div class="recipient-address">${recipient.wallet}</div>
                    <div class="info-item">
                        <span class="info-label">Allocation</span>
                        <span class="info-value">${recipient.percentage}%</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Total Amount</span>
                        <span class="info-value">${formatSolanaTokenAmount(allocation.toString())}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Claimed</span>
                        <span class="info-value">${formatSolanaTokenAmount(recipient.claimedAmount)}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Last Claim</span>
                        <span class="info-value">${recipient.lastClaimTime > 0 ? new Date(Number(recipient.lastClaimTime) * 1000).toLocaleDateString() : 'Never'}</span>
                    </div>
                `;
                
                container.appendChild(recipientDiv);
            });
        }

        function formatTokenAmount(amount) {
            try {
                const value = BigInt(amount);
                const decimals = 18;
                const divisor = BigInt(10 ** decimals);
                const quotient = value / divisor;
                const remainder = value % divisor;
                
                if (remainder === BigInt(0)) {
                    return quotient.toString();
                } else {
                    const remainderStr = remainder.toString().padStart(decimals, '0');
                    const trimmed = remainderStr.replace(/0+$/, '');
                    return `${quotient}.${trimmed}`;
                }
            } catch (error) {
                return '0';
            }
        }

        function formatSolanaTokenAmount(amount) {
            try {
                const value = BigInt(amount);
                // Предполагаем 9 decimals для Solana токенов (стандартно)
                const decimals = 9;
                const divisor = BigInt(10 ** decimals);
                const quotient = value / divisor;
                const remainder = value % divisor;
                
                if (remainder === BigInt(0)) {
                    return quotient.toString();
                } else {
                    const remainderStr = remainder.toString().padStart(decimals, '0');
                    const trimmed = remainderStr.replace(/0+$/, '');
                    return `${quotient}.${trimmed}`;
                }
            } catch (error) {
                return '0';
            }
        }

        function formatDuration(seconds) {
            const sec = Number(seconds);
            if (sec === 0) return 'No cliff';
            
            const minutes = Math.floor(sec / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `${days} day${days > 1 ? 's' : ''}`;
            if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''}`;
            if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''}`;
            return `${sec} second${sec > 1 ? 's' : ''}`;
        }

        // Cleanup interval on page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>